// /.netlify/functions/validate-payment.js
const Stripe = require('stripe');

exports.handler = async (event) => {
  // Only allow POST requests
  if (event.httpMethod !== 'POST') {
    return {
      statusCode: 405,
      body: JSON.stringify({ error: 'Method not allowed' }),
    };
  }
  
  try {
    const { paymentIntentId, clientSecret } = JSON.parse(event.body);
    
    // Initialize Stripe with secret key
    const stripe = Stripe(process.env.STRIPE_SECRET_KEY);
    
    // Retrieve the payment intent
    const paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentId);
    
    // Verify the client secret matches
    if (paymentIntent.client_secret !== clientSecret) {
      return {
        statusCode: 400,
        body: JSON.stringify({ error: 'Invalid client secret' }),
      };
    }
    
    // Check if payment was successful
    if (paymentIntent.status !== 'succeeded') {
      return {
        statusCode: 400,
        body: JSON.stringify({ error: `Payment not successful. Status: ${paymentIntent.status}` }),
      };
    }
    
    // Extract relevant data (mask sensitive information)
    const paymentDetails = {
      amount: paymentIntent.amount,
      currency: paymentIntent.currency,
      paymentIntentId: paymentIntent.id,
      name: paymentIntent.shipping ? paymentIntent.shipping.name : 'Not provided',
      email: paymentIntent.receipt_email || 'Not provided',
      donationBy: paymentIntent.metadata ? paymentIntent.metadata.donation_by : 'Not specified'
    };
    
    return {
      statusCode: 200,
      body: JSON.stringify(paymentDetails),
    };
  } catch (error) {
    console.error('Error validating payment:', error);
    
    return {
      statusCode: 500,
      body: JSON.stringify({ 
        error: error.message 
      }),
    };
  }
};


is ok?